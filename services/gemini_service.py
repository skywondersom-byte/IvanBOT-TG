# services/gemini_service.py

import google.generativeai as genai
import logging
import json
import asyncio
import random
from typing import Optional
from functools import wraps

# –Ü–º–ø–æ—Ä—Ç–∏ –∑ –∫–æ—Ä–µ–Ω—è –ø—Ä–æ–µ–∫—Ç—É
from config import settings
from models import PropertyData
# –Ü–º–ø–æ—Ä—Ç –∑ –ø–æ—Ç–æ—á–Ω–æ—ó –ø–∞–ø–∫–∏
from .cache_service import cache
# –Ü–º–ø–æ—Ä—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç
from utils.constants import RetryConfig

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
genai.configure(api_key=settings.GEMINI_API_KEY)

# –í–∏—Å–æ–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó "–ª—é–¥—è–Ω–æ—Å—Ç—ñ" —ñ –≤–∞—Ä—ñ–∞—Ç–∏–≤–Ω–æ—Å—Ç—ñ
generation_config = genai.types.GenerationConfig(
    temperature=0.9,
)
model = genai.GenerativeModel(model_name="gemini-2.5-flash", generation_config=generation_config)

def retry_on_error(max_retries=RetryConfig.MAX_RETRIES, delay=RetryConfig.RETRY_DELAY):
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            for attempt in range(max_retries):
                try:
                    return await func(*args, **kwargs)
                except Exception as e:
                    if attempt == max_retries - 1:
                        logging.error(f"–í—Å—ñ —Å–ø—Ä–æ–±–∏ –≤–∏—á–µ—Ä–ø–∞–Ω–æ –¥–ª—è {func.__name__}: {e}")
                        raise e
                    logging.warning(f"–°–ø—Ä–æ–±–∞ {attempt + 1} –Ω–µ–≤–¥–∞–ª–∞: {e}. –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ {delay}—Å...")
                    await asyncio.sleep(delay)
        return wrapper
    return decorator

@retry_on_error()
async def extract_base_data(text: str) -> Optional[PropertyData]:
    if not text:
        return None

    cached_data = cache.get(text, "base_data")
    if cached_data:
        logging.info("–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –∫–µ—à–æ–≤–∞–Ω—ñ –±–∞–∑–æ–≤—ñ –¥–∞–Ω—ñ")
        return PropertyData(**cached_data)

    prompt = f"""
    –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π —Ç–µ–∫—Å—Ç –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è –ø—Ä–æ –æ—Ä–µ–Ω–¥—É –Ω–µ—Ä—É—Ö–æ–º–æ—Å—Ç—ñ.
    –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤–∏—Ç—è–≥–Ω—É—Ç–∏ –∑ –Ω—å–æ–≥–æ –∫–ª—é—á–æ–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é —ñ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ —É —Ñ–æ—Ä–º–∞—Ç—ñ JSON.

    –ü–æ–ª—è –¥–ª—è –≤–∏–ª—É—á–µ–Ω–Ω—è:
    1. "type": –¢–∏–ø –Ω–µ—Ä—É—Ö–æ–º–æ—Å—Ç—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: "2-–∫—ñ–º–Ω–∞—Ç–Ω–∞ –∫–≤–∞—Ä—Ç–∏—Ä–∞", "–°—Ç—É–¥—ñ—è", "–ö—ñ–º–Ω–∞—Ç–∞"). –ü–µ—Ä–µ–∫–ª–∞–¥–∏ —Ü–µ –Ω–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫—É –º–æ–≤—É. –ü–∏—à–∏ —Ç—ñ–ª—å–∫–∏ —Ç–∏–ø, –ª–∞–∫–æ–Ω—ñ—á–Ω–æ, –±–µ–∑ –∑–∞–π–≤–∏—Ö —Å–ª—ñ–≤.
    2. "price": –¶—ñ–Ω–∞ (–ø—Ä–æ—Å—Ç–æ —Ü–∏—Ñ—Ä–∞ —ñ –≤–∞–ª—é—Ç–∞, —è–∫—â–æ —î).
    3. "location": –†–∞–π–æ–Ω –∞–±–æ –∞–¥—Ä–µ—Å–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: "–°—Ç—Ä–∞—Ç—Ñ–æ—Ä–¥", "–õ–æ–Ω–¥–æ–Ω, E15"). –ü–µ—Ä–µ–∫–ª–∞–¥–∏ –∞–±–æ —Ç—Ä–∞–Ω—Å–ª—ñ—Ç–µ—Ä—É–π –Ω–∞–∑–≤–∏ –Ω–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫—É –º–æ–≤—É.

    –ü—Ä–∞–≤–∏–ª–∞:
    - –Ø–∫—â–æ —è–∫–µ—Å—å –ø–æ–ª–µ –Ω–µ–º–æ–∂–ª–∏–≤–æ –∑–Ω–∞–π—Ç–∏, –≤—Å—Ç–∞–Ω–æ–≤–∏ –¥–ª—è –Ω—å–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è "-".
    - –¢–≤–æ—è –≤—ñ–¥–ø–æ–≤—ñ–¥—å –º–∞—î –±—É—Ç–∏ –¢–Ü–õ–¨–ö–ò —É —Ñ–æ—Ä–º–∞—Ç—ñ JSON.

    –¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É:
    ---
    {text}
    ---
    """
    try:
        # –î–ª—è –≤–∏–ª—É—á–µ–Ω–Ω—è —Ñ–∞–∫—Ç—ñ–≤ (JSON) –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–∞ —Ç–æ—á–Ω—ñ—Å—Ç—å
        json_gen_config = genai.types.GenerationConfig(response_mime_type="application/json", temperature=0.1)
        response = await model.generate_content_async(prompt, generation_config=json_gen_config)
        
        raw_data = json.loads(response.text)
        validated_data = PropertyData(**raw_data)
        
        cache.set(text, "base_data", validated_data.model_dump())
        return validated_data

    except Exception as e:
        logging.error(f"–ü–æ–º–∏–ª–∫–∞ –≤ extract_base_data: {e}")
        return None

async def generate_description(text: str, max_length: int, property_type: str, property_location: str, property_price: str) -> str | None:
    if not text or max_length <= 0:
        return ""

    # –î–æ–¥–∞—î–º–æ —Ä–∞–Ω–¥–æ–º—ñ–∑–∞—Ü—ñ—é, —â–æ–± —Ç–µ–∫—Å—Ç–∏ –±—É–ª–∏ —Ä—ñ–∑–Ω—ñ
    random_seed = random.randint(1, 10000)

    # –í–∏–±–∏—Ä–∞—î–º–æ –≤–∏–ø–∞–¥–∫–æ–≤–∏–π —Å—Ç–∏–ª—å –ø–æ–±—É–¥–æ–≤–∏ —Ç–µ–∫—Å—Ç—É
    styles = [
        "neutral_story",     # –†–æ–∑–ø–æ–≤—ñ–¥—å –ø—Ä–æ –∫–≤–∞—Ä—Ç–∏—Ä—É
        "location_focus",    # –ê–∫—Ü–µ–Ω—Ç –Ω–∞ –ª–æ–∫–∞—Ü—ñ—ó
        "comfort_focus"      # –ê–∫—Ü–µ–Ω—Ç –Ω–∞ –∑—Ä—É—á–Ω–æ—Å—Ç—è—Ö
    ]
    chosen_style = random.choice(styles)

    prompt = f"""
    –ù–∞–ø–∏—à–∏ –ø—Ä–æ—Å—Ç–µ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è –ø—Ä–æ –æ—Ä–µ–Ω–¥—É –∂–∏—Ç–ª–∞ –¥–ª—è Telegram —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é.

    –í–•–Ü–î–ù–Ü –î–ê–ù–Ü:
    - –¢–∏–ø –∂–∏—Ç–ª–∞: {property_type}
    - –õ–æ–∫–∞—Ü—ñ—è: {property_location}
    - –¶—ñ–Ω–∞: {property_price}
    - –î–µ—Ç–∞–ª—ñ: {text}

    –ì–û–õ–û–í–ù–ï –ü–†–ê–í–ò–õ–û - –ü–ò–®–ò –Ø–ö –ó–í–ò–ß–ê–ô–ù–ê –õ–Æ–î–ò–ù–ê:
    - –£—è–≤–∏, —â–æ —Ü–µ —Ç–≤–æ—è –∑–Ω–∞–π–æ–º–∞ –∑–¥–∞—î —Å–≤–æ—é –∫–≤–∞—Ä—Ç–∏—Ä—É —ñ –ø—Ä–æ—Å–∏—Ç—å —Ç–µ–±–µ –Ω–∞–ø–∏—Å–∞—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è
    - –ü–∏—à–∏ –ø—Ä–æ—Å—Ç–æ, –±–µ–∑ —Ä—ñ—î–ª—Ç–æ—Ä—Å—å–∫–∏—Ö —à—Ç–∞–º–ø—ñ–≤
    - –ù—ñ—è–∫–∏—Ö "—ñ–¥–µ–∞–ª—å–Ω–∏–π –≤–∏–±—ñ—Ä", "–≤–∏—à—É–∫–∞–Ω–∞ –∫–≤–∞—Ä—Ç–∏—Ä–∞", "–ø—Ä–æ–ø–æ–Ω—É—î –¥–∏–≤–æ–≤–∏–∂–Ω—ñ –≤–∏–¥–∏"
    - –ù—ñ—è–∫–∏—Ö —Å–ø–∏—Å–∫—ñ–≤ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –ø–æ—Å–ª—É–≥, —Å–æ—Ü–º–µ—Ä–µ–∂, –º–æ–≤ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è
    - –ü—Ä–æ—Å—Ç–æ –æ–ø–∏—à–∏ –∂–∏—Ç–ª–æ, –≤–∫–∞–∂–∏ —Ü—ñ–Ω—É, –ª–æ–∫–∞—Ü—ñ—é, –∫–æ–Ω—Ç–∞–∫—Ç

    –°–¢–ò–õ–¨ (–ë–ï–ó–û–°–û–ë–û–í–ò–ô, –ê–õ–ï –ü–†–û–°–¢–ò–ô):
    - –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π: "–ó–¥–∞—î—Ç—å—Å—è", "–í—ñ–ª—å–Ω–∞", "–î–æ—Å—Ç—É–ø–Ω–∞"
    - –ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –≤—ñ–¥ –ø–µ—Ä—à–æ—ó –æ—Å–æ–±–∏ ("–∑–¥–∞—é", "–ø—Ä–æ–ø–æ–Ω—É—î–º–æ")
    - –ü–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ —ñ –ø–æ —Å—É—Ç—ñ

    –°–¢–†–£–ö–¢–£–†–ê (—Å—Ç–∏–ª—å –¥–ª—è —Ü—å–æ–≥–æ –ø–æ—Å—Ç—É: {chosen_style}):

    1. "neutral_story" - –ø—Ä–æ—Å—Ç–æ —Ä–æ–∑–ø–æ–≤—ñ–¥—å:
       "–ó–¥–∞—î—Ç—å—Å—è {property_type} –Ω–∞ {property_location}. [–ö–æ—Ä–æ—Ç–∫–æ –ø—Ä–æ –∑—Ä—É—á–Ω–æ—Å—Ç—ñ]. –í–∞—Ä—Ç—ñ—Å—Ç—å ‚Äî {property_price}. –¢–µ–ª–µ—Ñ–æ–Ω: +447796029457 (–¢–µ–ª–µ–≥—Ä–∞–º)."

    2. "location_focus" - –ø–æ—á–Ω–∏ –∑ –ª–æ–∫–∞—Ü—ñ—ó:
       "–ù–∞ {property_location} –≤—ñ–ª—å–Ω–∞ {property_type}. [–û–ø–∏—Å]. –û—Ä–µ–Ω–¥–∞ {property_price}. –ó–≤'—è–∑–æ–∫: +447796029457 (–¢–µ–ª–µ–≥—Ä–∞–º)."

    3. "comfort_focus" - –∞–∫—Ü–µ–Ω—Ç –Ω–∞ –∑—Ä—É—á–Ω–æ—Å—Ç—ñ:
       "{property_type} –∑ [–ø–µ—Ä–µ–ª—ñ–∫ –∑—Ä—É—á–Ω–æ—Å—Ç–µ–π]. –ó–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –Ω–∞ {property_location}, {property_price} –Ω–∞ –º—ñ—Å—è—Ü—å. –ö–æ–Ω—Ç–∞–∫—Ç: +447796029457 (–¢–µ–ª–µ–≥—Ä–∞–º)."

    –í–ê–ñ–õ–ò–í–û –ü–†–û –î–ê–¢–ò:
    - –ù–ï –≤–∫–∞–∑—É–π –¥–∞—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ (–∑ —è–∫–æ–≥–æ –ø–æ —è–∫–µ —á–∏—Å–ª–æ)
    - –ù–∞–≤—ñ—Ç—å —è–∫—â–æ –¥–∞—Ç–∏ —î —É –≤—Ö—ñ–¥–Ω–æ–º—É —Ç–µ–∫—Å—Ç—ñ, –ù–ï –≤–∫–ª—é—á–∞–π —ó—Ö –≤ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è
    - –ü–∏—à–∏ –ø—Ä–æ –∫–≤–∞—Ä—Ç–∏—Ä—É —Ç–∞–∫, –Ω—ñ–±–∏ –≤–æ–Ω–∞ –ø—Ä–æ—Å—Ç–æ –∑–¥–∞—î—Ç—å—Å—è

    –ó–ê–ë–û–†–û–ù–ï–ù–Ü –§–†–ê–ó–ò (—Ä—ñ—î–ª—Ç–æ—Ä—Å—å–∫—ñ —à—Ç–∞–º–ø–∏):
    ‚ùå "–≤–∏—à—É–∫–∞–Ω–∞ –∫–≤–∞—Ä—Ç–∏—Ä–∞"
    ‚ùå "—ñ–¥–µ–∞–ª—å–Ω–∏–π –≤–∏–±—ñ—Ä"
    ‚ùå "—ñ–¥–µ–∞–ª—å–Ω–µ –º—ñ—Å—Ü–µ –¥–ª—è"
    ‚ùå "–ø—Ä–æ–ø–æ–Ω—É—î –¥–∏–≤–æ–≤–∏–∂–Ω—ñ –≤–∏–¥–∏"
    ‚ùå "—Ü–µ —á—É–¥–æ–≤–∞ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å"
    ‚ùå "–¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ–±—É–≤–∞–Ω–Ω—è"
    ‚ùå "–±—É–¥—É —Ä–∞–¥–∏–π –æ–±–≥–æ–≤–æ—Ä–∏—Ç–∏"
    ‚ùå "—Ç–∞–∫–æ–∂ –¥–æ—Å—Ç—É–ø–Ω—ñ —ñ–Ω—à—ñ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó"
    ‚ùå "—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –Ω–∞ Facebook/Instagram"
    ‚ùå "—Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è –º–æ–∂–ª–∏–≤–µ"
    ‚ùå "–¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Ç–∞ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è"

    –î–û–ó–í–û–õ–ï–ù–Ü –§–†–ê–ó–ò (–ø—Ä–æ—Å—Ç—ñ, –ª—é–¥—Å—å–∫—ñ):
    ‚úÖ "–∑–∞—Ç–∏—à–Ω–∞ –∫–≤–∞—Ä—Ç–∏—Ä–∞"
    ‚úÖ "–ø—Ä–æ—Å—Ç–æ—Ä–Ω–∞"
    ‚úÖ "–∑—Ä—É—á–Ω–æ —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω–∞"
    ‚úÖ "—î —Ç–µ—Ä–∞—Å–∞/–∫–æ–Ω–¥–∏—Ü—ñ–æ–Ω–µ—Ä"
    ‚úÖ "–≥–∞—Ä–Ω—ñ –∫—Ä–∞—î–≤–∏–¥–∏"
    ‚úÖ "–¥–≤—ñ —Å–ø–∞–ª—å–Ω—ñ –∑ –≤–∞–Ω–Ω–∏–º–∏"

    –û–ë–ú–ï–ñ–ï–ù–ù–Ø:
    - –î–æ–≤–∂–∏–Ω–∞ –¥–æ {max_length} —Å–∏–º–≤–æ–ª—ñ–≤
    - –ñ–æ–¥–Ω–∏—Ö —Å–º–∞–π–ª—ñ–≤ emoji
    - –ñ–æ–¥–Ω–∏—Ö —ñ–∫–æ–Ω–æ–∫ üìçüè†üí∞
    - –¢—ñ–ª—å–∫–∏ –æ–¥–∏–Ω –∫–æ–Ω—Ç–∞–∫—Ç: +447796029457 (–¢–µ–ª–µ–≥—Ä–∞–º)
    - –ù–ï –¥–æ–¥–∞–≤–∞–π —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —ñ–Ω—à—ñ –ø–æ—Å–ª—É–≥–∏, —Å–æ—Ü–º–µ—Ä–µ–∂—ñ —á–∏ –º–æ–≤–∏

    –ü–†–ò–ö–õ–ê–î –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –¢–ï–ö–°–¢–£:
    "–ó–¥–∞—î—Ç—å—Å—è –∑–∞—Ç–∏—à–Ω–∞ –¥–≤–æ–∫—ñ–º–Ω–∞—Ç–Ω–∞ –∫–≤–∞—Ä—Ç–∏—Ä–∞ –Ω–∞ –ï—Ä–ª—Å –ö–æ—Ä—Ç –†–æ—É–¥ —É –ö–µ–Ω—Å—ñ–Ω–≥—Ç–æ–Ω—ñ. –Ñ —Ç–µ—Ä–∞—Å–∞, –∫–æ–Ω–¥–∏—Ü—ñ–æ–Ω–µ—Ä, –≥–∞—Ä–Ω—ñ –∫—Ä–∞—î–≤–∏–¥–∏ –∑ –¥–∞—Ö—É. –ö–æ–∂–Ω–∞ —Å–ø–∞–ª—å–Ω—è –∑ –≤–ª–∞—Å–Ω–æ—é –≤–∞–Ω–Ω–æ—é. –í–∞—Ä—Ç—ñ—Å—Ç—å 4000 —Ñ—É–Ω—Ç—ñ–≤ –Ω–∞ –º—ñ—Å—è—Ü—å. –¢–µ–ª–µ—Ñ–æ–Ω: +447796029457 (–¢–µ–ª–µ–≥—Ä–∞–º)."

    –ù–∞–ø–∏—à–∏ –¢–Ü–õ–¨–ö–ò —Ç–µ–∫—Å—Ç –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è, –±–µ–∑ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤.
    """
    try:
        response = await model.generate_content_async(prompt)
        desc_text = response.text.strip()
        
        # –í–∏–¥–∞–ª—è—î–º–æ —Ä—ñ—î–ª—Ç–æ—Ä—Å—å–∫—ñ —Ñ—Ä–∞–∑–∏, —è–∫—â–æ AI –≤—Å–µ –∂ —ó—Ö –¥–æ–¥–∞–≤
        spam_phrases = [
            "–¢–∞–∫–æ–∂ –¥–æ—Å—Ç—É–ø–Ω—ñ —ñ–Ω—à—ñ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó",
            "–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –Ω–∞ Facebook",
            "–°–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è –º–æ–∂–ª–∏–≤–µ",
            "–≤–∫–ª—é—á–∞—é—á–∏ —Ü—ñ–ª—ñ –ø–æ–º–µ—à–∫–∞–Ω–Ω—è",
            "—è–∫—ñ –º–æ–∂–Ω–∞ –ø—ñ–¥—ñ–±—Ä–∞—Ç–∏",
            "Tik-Tok",
            "Instagram",
            "—É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é, –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é, —Ä–æ—Å—ñ–π—Å—å–∫–æ—é, –ø–æ–ª—å—Å—å–∫–æ—é",
            "–¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Ç–∞ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è",
            "–±—É–¥—É —Ä–∞–¥–∏–π –æ–±–≥–æ–≤–æ—Ä–∏—Ç–∏ –¥–µ—Ç–∞–ª—ñ",
            "–í—ñ–ª—å–Ω–∞ –∑",
            "–î–æ—Å—Ç—É–ø–Ω–∞ –∑",
            "–¥–æ ",
            "–ø–æ ",
            "—Å—ñ—á–Ω—è",
            "–ª—é—Ç–æ–≥–æ",
            "–±–µ—Ä–µ–∑–Ω—è",
            "–∫–≤—ñ—Ç–Ω—è",
            "—Ç—Ä–∞–≤–Ω—è",
            "—á–µ—Ä–≤–Ω—è",
            "–ª–∏–ø–Ω—è",
            "—Å–µ—Ä–ø–Ω—è",
            "–≤–µ—Ä–µ—Å–Ω—è",
            "–∂–æ–≤—Ç–Ω—è",
            "–ª–∏—Å—Ç–æ–ø–∞–¥–∞",
            "–≥—Ä—É–¥–Ω—è",
            "2024",
            "2025",
            "2026"
        ]
        
        for phrase in spam_phrases:
            if phrase in desc_text:
                # –í–∏–¥–∞–ª—è—î–º–æ —Ä–µ—á–µ–Ω–Ω—è –∑ —Ü—ñ—î—é —Ñ—Ä–∞–∑–æ—é
                sentences = desc_text.split('.')
                filtered = [s for s in sentences if phrase not in s]
                desc_text = '.'.join(filtered)
        
        # –°—Ç—Ä–∞—Ö–æ–≤–∫–∞: —è–∫—â–æ AI –∑–∞–±—É–≤ –¥–æ–¥–∞—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω, –¥–æ–¥–∞–º–æ –π–æ–≥–æ
        target_phone = "+447796029457 (–¢–µ–ª–µ–≥—Ä–∞–º)"
        if "447796029457" not in desc_text:
            connectors = ["–¢–µ–ª–µ—Ñ–æ–Ω:", "–ö–æ–Ω—Ç–∞–∫—Ç:", "–ó–≤'—è–∑–æ–∫:"]
            connector = random.choice(connectors)
            desc_text = desc_text.rstrip('.') + f". {connector} {target_phone}"
        
        # –û—á–∏—Å—Ç–∫–∞ –≤—ñ–¥ –ø—Ä–∏–≤—ñ—Ç–∞–Ω—å
        forbidden_starts = ["–í—Å—ñ–º –ø—Ä–∏–≤—ñ—Ç", "–ü—Ä–∏–≤—ñ—Ç", "–í—ñ—Ç–∞—é", "–î–æ–±—Ä–æ–≥–æ –¥–Ω—è"]
        for start in forbidden_starts:
            if desc_text.lower().startswith(start.lower()):
                parts = desc_text.split('.', 1)
                if len(parts) > 1:
                    desc_text = parts[1].strip()

        logging.info(f"GEMINI (description): –°—Ç–∏–ª—å {chosen_style}, –î–æ–≤–∂–∏–Ω–∞ {len(desc_text)}")
        return desc_text
    except Exception as e:
        logging.error(f"–ü–æ–º–∏–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –æ–ø–∏—Å—É: {e}", exc_info=True)
        return None